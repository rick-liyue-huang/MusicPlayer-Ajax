<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0, user-scalable=no">

	<title>Music Player</title>
	<style type="text/css">

	/* the initial layout */
		* {
			margin: 0;
			padding: 0;
		}

		html {
			width: 100%;
			height: 100%;
			overflow: hidden;
		}

		body {
			width: 100%;
			height: 100%;
			font: 14px/1.5 Tahoma, Arial, Roboto, "Droid Sans", sans-self;
		}

		li {
			list-style: none;
		}

		#main {
			width: 100%;
			height: 100%;
			position: relative;
			margin: 0 auto;
		}

		/* music list page layout */

		#musicList {
			width: 100%;
			height: 100%;
			background: url(img/bg.jpg) no-repeat;
			background-size: cover;
		}

		#musicList .list_title {
			width: 100%;
			height: 40px;
			background: rgba(41, 171, 226, 0.6);
			font-size: 20px;
			line-height: 40px;
			text-align: center;
			color: white;
			position: absolute;
			top: 0;
		}

		#musicList .list_tip {
			width: 16px;
			height: 16px;
			background: url(img/tip.png) no-repeat;
			background-size: cover;
			position: absolute;
			right: 15px;
			top: 12px;
		}

		#musicList .list_content {
			width: 100%;
			position: absolute;
			top: 39px;
			bottom: 65px;
			overflow: hidden;
		}

		#musicList .list_content ul {
			width: 100%;
			position: absolute;
			top: 0;
			left: 0;
			transform: translate3d(0, 0, 0);
		}

		#musicList .list_content ul li {
			width: 100%;
			height: 60px;
			background: rgb(26, 26, 26, 0.6);
			border-bottom: 1px solid #999;
			box-sizing: border-box;
		}

		#musicList .list_content ul li.active {
			border-left: 6px solid #29abe2;
		}

		#musicList .list_audio {
			width: 100%;
			height: 65px;
			background: url(img/list_audioBg.png) repeat-x;
			position: absolute;
			bottom: 0;
		}

		#musicList .list_audioImg {
			width: 50px;
			border-radius: 50%;
			float: left;
			margin: 7px 0 0 15px;
		}

		#musicList .list_audioImg.move {
			animation: 4s linear infinite audioImgMove;
			-webkit-animation: 4s linear infinite audioImgMove;
		}

		@keyframes audioImgMove {
			0% {
				transform: rotate(0deg);
			}
			100% {
				transform: rotate(360deg);
			}
		}
		@-webkit-keyframes audioImgMove {
			0% {
				transform: rotate(0deg);
			}
			100% {
				transform: rotate(360deg);
			}
		}

		#musicList .list_audioText {
			float: left;
		}

		#musicList .list_audioBtn {
			float: right;
			width: 32px;
			height: 32px;
			background: url(img/list_audioPlay.png) no-repeat;
			display: none;
			background-size: cover;
			margin: 16px 15px 0 0;
		}

		/* music detail page layout */
		
		#musicDetails {
			width: 100%;
			height: 100%;
			background: url(img/detailsBg.jpg) no-repeat;
			background-size: cover;
			position: absolute;
			top: 0;
			left: 0;
			z-index: 16;
			background-position: bottom;
		}

		#musicDetails .details_title {
			width: 100%;
			height: 40px;
			background: rgba(41, 171, 226, 0.6);
			font-size: 20px;
			line-height: 40px;
			text-align: center;
			color: white;
			position: absolute;
			top: 0;
		}

		#musicDetails .details_name span {
			font-size: 12px; 
		}

		#musicDetails .details_title .details_tip {
			width: 19px;
			height: 10px;
			background: url(img/details_arrow.png) no-repeat;
			background-size: cover;
			position: absolute;
			right: 15px;
			top: 15px;
		}

		#musicDetails .details_lyric {
			width: 100%;
			position: absolute;
			top: 40px;
			bottom: 150px;
			overflow: hidden;

			transition: 0.5s;
			-webkit-transition: 0.5s;
		}

		#musicDetails .details_lyric ul {
			width: 100%;
			text-align: center;
			color: white;
			font-size: 16px;
			position: absolute;
			top: 0;
			left: 0;
			transition: 0.2s;
			-webkit-transition: 0.2s;
		}

		#musicDetails .details_lyric ul li {
			margin-top: 15px;
		}

		#musicDetails .details_lyric ul li.active {
			color: #0ff;
		}

		#musicDetails .details_audio {
			width: 100%;
			height: 150px;
			position: absolute;
			bottom: 0;
			/*background-color: green;*/

			transition: 0.5s;
			-webkit-transition: 0.5s;
		}

		#musicDetails .details_audio .details_audioAll {
			width: 200px; 
			margin: 20px auto;
			position: relative;
			/*background-color: purple;*/
		}

		#musicDetails .details_audioPro {
			width: 100%;
			height: 2px;
			background-color: white;
		}

		#musicDetails .details_audioProUp {
			width: 0;
			height: 2px;
			background-color: #29abe2;
		}

		#musicDetails .details_audioProBar {
			width: 15px;
			height: 15px;
			background-color: #29abe2;
			border-radius: 50%;
			position: absolute;
			left: 0;
			top: 0;
			margin: -6px;

		}

		#musicDetails .details_nowTime {
			font-size: 12px;
			color: #b3b3b3;
			position: absolute;
			top: -6px;
			left: -40px; 
		}

		#musicDetails .details_allTime {
			font-size: 12px;
			color: #b3b3b3;
			position: absolute;
			top: -6px;
			right: -40px; 
		}

		#musicDetails .details_play {
			width: 55px;
			height: 55px;
			background: url(img/details_play.png) no-repeat;
			background-size: cover;
			position: absolute;
			left: 50%;
			margin-left: -26px;
			top: 30px;
		}

		#musicDetails .details_prev {
			width: 37px;
			height: 37px;
			background: url(img/details_prev.png) no-repeat;
			background-size: cover;
			position: absolute;
			left: 12px;
			top: 39px;
		}

		#musicDetails .details_next {
			width: 37px;
			height: 37px;
			background: url(img/details_next.png) no-repeat;
			background-size: cover;
			position: absolute;
			right: 12px;
			top: 39px;
		}

		#musicDetails .details_message {
			width: 80%;
			position: absolute;
			top: 40px;
			bottom: 50px;
			margin-left: 10%;

			transition: 0.5s;
			-webkit-transition: 0.5s;
		}

		#musicDetails .details_message textarea {
			width: 100%;
			height: 100px;
			background: #9babb2;
			border-radius: 5px;
			margin-top: 10px;
		}

		::-webkit-input-placeholder {
			color: black;
		}
		::-moz-webkit-input-placeholder {
			color: black;
		}

		#musicDetails .details_message input {
			width: 100%;
			height: 30px;
			color: white;
			background-color: #29abe2;
			border-radius: 5px;
			border: none;
		}

		#musicDetails .details_message ul {
			width: 100%;
			font-size: 12px;
		}

		#musicDetails .details_message ul li {
			background-color: rgba(26, 26, 26, 0.6);
			border-radius: 5px;
			padding: 10px;
			color: white;
			float: left;
			clear: both;
			margin-top: 6px;

			transition: 1s;
			-webkit-transition: 1s;
		}


		#musicDetails .details_btn {
			width: 100%;
			position: absolute;
			bottom: 10px;
			text-align: center;
		}

		#musicDetails .details_btn li {
			width: 8px;
			height: 8px;
			background-color: #29abe2;
			border-radius: 5px;
			display: inline-block; 
			margin: 3px;

			transition: 0.5s;
			-webkit-transition:  0.5s;
		}

		#musicDetails .details_btn li.active{
			width: 21px;

		}

		.title {
			 color: white;
			 font-size: 15px;
			 padding: 10px 0 0 20px;
		}

		.name {
			color: lightgrey;
			font-size: 12px;
			padding: 2px 0 0 20px;
		}



	</style>
</head>
<body>
	
	<div id="main">

		<!-- list page -->
		<div id="musicList">

			<!-- title part in list page -->
			<div id="listTitle" class="list_title">Ajax Music Player<span class="list_tip"></span></div>
			
			<!-- song list part in list page -->
			<div id="listContent" class="list_content">
				<ul id="listContentUl">
					<!-- <li class="active">
						<h3 class="title">song name</h3>
						<p class="name">singer</p>
					</li> -->


					

				</ul>
			</div>
			
			<!-- audio play part in list page -->
			<div id="listAudio" class="list_audio">
				<img id="listAudioImg" class="list_audioImg" src="img/miaov.jpg">
				<div id="listAudioText" class="list_audioText">
					<h3 class="title">Simulation</h3>
					<p class="name">Music Player</p>
				</div>
				<div id="listAudioBtn" class="list_audioBtn"></div>
			</div>
		</div>
		
		<!-- detail page -->
		<div id="musicDetails">

			<!-- Title part in detail page -->
			<div id="detailsTitle" class="details_title">
				<div id="detailsName" class="details_name" >music
					<span>name</span>
				</div>
				<span class="details_tip"></span>
			</div>

			<div id="detailsLyric" class="details_lyric">
				<ul id="detailsLyricUl">
					<!-- <li>lyric test</li> -->
					
				</ul>
			</div>
			
			<!-- audio play part in detail page -->
			<div id="detailsAudio" class="details_audio">
				<div class="details_audioAll">
					<div class="details_audioPro">
						<div id="detailsAudioProUp" class="details_audioProUp"></div>
						<div id="detailsAudioProBar" class="details_audioProBar"></div>
					</div>
					<div id="detailsNowTime" class="details_nowTime">00:00</div>
					<div id="detailsAllTime" class="details_allTime">00:00</div>
					<div id="detailsPlay" class="details_play"></div>
					<div id="detailsPrev" class="details_prev"></div>
					<div id="detailsNext" class="details_next"></div>
				</div>
			</div>
			
			<!-- the message part in detail page -->
			<div id="detailsMessage" class="details_message">
				<textarea id="detailsMessageText" placeholder="please send your message"></textarea>
				<input id="detailsMessageBtn" type="button" name="" value="Sumbit">
				<ul id="detailsMessageUl">
					<!-- <li>ok</li>
					<li>good</li>
					<li>great</li> -->
				</ul>
			</div>

			<!-- detail button on the bottom in detail page -->
			<ul id="detailsBtn" class="details_btn">
				<li class="active"></li>
				<li></li>
			</ul>
		</div>

	</div>

	<audio id="audio1"></audio>

	<script type="text/javascript" src="jquery-2.1.3.min.js"></script>
	<script type="text/javascript">
		
		// console.log($(window).width()); // set width

		var viewWidth = $(window).width();
		var viewHeight = $(window).height();
		var desWidth = 640;

		// set three variable used to flag the touch method
		var touchstart = 'touchstart';
		var touchmove = 'touchmove';
		var touchend = 'touchend';
		
		// search id in database
		var id = 0;

		// search index in the music list
		var index = 0;
		// 
		var oAudio = $('#audio1').get(0);
		// console.log(oAudio);

		var $main = $('#main');
		var $listContent = $('#listContent');

		var $listContentUl = $('#listContentUl');
		var $listTitle = $('#listTitle');
		var $listAudio = $('#listAudio');
		var $listAudioImg = $('#listAudioImg');
		var $listAudioText = $('#listAudioText');
		var $listAudioBtn = $('#listAudioBtn');

		var $musicDetails = $('#musicDetails');
		var $detailsTitle = $('#detailsTitle');
		var $detailsName = $('#detailsName');
		var $detailsAudioProUp = $('#detailsAudioProUp');
		var $detailsAudioProBar = $('#detailsAudioProBar');
		var $detailsNowTime = $('#detailsNowTime');
		var $detailsAllTime = $('#detailsAllTime');
		var $detailsPlay = $('#detailsPlay');
		var $detailsPrev = $('#detailsPrev');
		var $detailsNext = $('#detailsNext');

		var $detailsLyric = $('#detailsLyric');
		var $detailsLyricUl = $('#detailsLyricUl');

		var $detailsAudio = $('#detailsAudio');
		var $detailsMessage = $('#detailsMessage');
		var $detailsMessageText = $('#detailsMessageText');
		var $detailsMessageBtn = $('#detailsMessageBtn');
		var $detailsMessageUl = $('#detailsMessageUl');
 		var $detailsBtn = $('#detailsBtn');

		function init() {
			// the whole project init method
			device();
			musicList.init();
			musicDetails.init();
			musicAudio.init();
		}

		
		function device() {
			// compatible desk and mobile end layout

			// console.log(navigator.userAgent);
			// through RegExp to confirm is mobile end or pc end.
			var isMobile = /Mobile/i.test(navigator.userAgent);
			console.log(isMobile);
			
			// confirm whether the device is mobile or pc
			if(viewWidth > desWidth) {
				
				// if it is pc, will let the pc device width is 640px
				$main.css('width', '640px');
			}
			
			// mobile 'touch' gesture is different from pc 'touch' gesture, if it is pc device, 'touch' means mouse click.
			if(!isMobile) {
				touchstart = 'mousedown';
				touchmove = 'mousemove';
				touchend = 'mouseup';
			}

			// set rotating the phone
			$(window).resize(function() {
				viewWidth = $(window).width();
				viewHeight = $(window).height();

				musicDetails.slideDown();
			});
		}
		
		// music list operation by IIFE 
		var musicList = (function() {
			
			// set url variable
			var musicUrl = 'http://play.google.com';
			var listUrl = 'musicList.php';
			
			// deal with scroll gesture
			var downY = 0;
			// the last previous y
			var preY = 0;
			var downTop = 0;

			// deal with content height, if list is less than content, donot need scroll.
			var parentHeight = $listContent.height();
			var childHeight = $listContentUl.height();

			// the switches deal with scroll gesture
			// head scroll
			var switchHead = true;
			// tail scroll
			var switchTail = true;
			// click scroll
			var switchScroll = true;

			// deal with scroll back when touchend.
			var timer = null;
			var speed = 0;
			
			// set 'init' function
			function init() {  // initiate the musiclist
				data();
				bind();
				moveScroll();
			}
			
			// get data from backend php file
			function data() { // get data
				
				/*
					here will get the data from backend database by jquery ajax
				*/

				$.ajax({
					url: listUrl, // the backend php file
					type: 'GET',
					dataType: 'json',
					success: function(data) {
						$.each(data, function(k, obj) {
							// traverse the 'data' and get 'obj' content
							var $li = '<li musicId = " ' + (obj.id) +' "><h3 class="title">' + obj.musicName + '</h3><p class="name">' + obj.name + '</p></li>';
							// append to 'ul' elem
							$listContentUl.append($li);

							// console.log(data);
						});

						console.log($listContentUl);
						
						// prevent asynchronous ajax affect child has no height.
						childHeight = $listContentUl.height();
					}


				});
			}

			function bind() {
				// click the 'list_title' to jump to another webpage
				$listTitle.on(touchstart, function() {
					// alert(666);

					window.location = musicUrl;
				});
				
				// by 'delegate' to bind with 'li'
				$listContentUl.delegate('li', touchend, function() {

					if(switchScroll) {
					
						// by jquery to remove all siblings 'class' attribute.
						$(this).attr('class', 'active').siblings().attr('class', '');

						// click the li get 'id'
						id = $(this).attr('musicId');

						// call outside method of 'musicAudio.loadMusic'
						musicAudio.loadMusic(id);

						// when click 'li' get the index
						index = $(this).index();
						console.log(index);
					}

					
				});

				$listAudio.on(touchstart, function() {
					
					// after click 'li' list, will produce 'id', and can invoke 'slideUp' event
					if(id) {
						musicDetails.slideUp();
					}
					
				})
				
			}
			
			// scroll the music list 
			function moveScroll() {
				
				// remove the default scroll gesture
				$(document).on(touchmove, function(ev) {
					ev.preventDefault();
				});
				
				/*
					touchstart {touchmove, touchend} three events

				*/ 
				$listContentUl.on(touchstart, function(ev) {
					
					// if ul list less than content height, no scroll gesture
					if(parentHeight > childHeight) {
						return false;
					}

					// ev.pageX,  touch.pageX

					// ev.originalEvent -> JQ event to js event
					// compatible with the pc and mobile 'touch'
					var touch = ev.originalEvent.changedTouches ? ev.originalEvent.changedTouches[0] : ev;
					
					// store the pageY
					downY = touch.pageY;
					preY = touch.pageY;
					downTop = $(this).position().top;

					var self = this;

					switchHead = true;
					switchTail = true;
					switchScroll = true;
					
					// remove timer
					clearInterval(timer);

					// console.log(touch.pageX);
				
					$(document).on(touchmove + '.move', function(ev) {
						
						// alert(666);
						switchScroll = false;

						var touch = ev.originalEvent.changedTouches ? ev.originalEvent.changedTouches[0] : ev;

						var iTop = $(self).position().top;
						
						// get speed value
						speed = touch.pageY - preY;
						preY = touch.pageY;

						if(iTop >= 0) {
							
							if(switchHead) {
								switchHead = false;
								downY = touch.pageY;
							}

							// touch on the head part of ul list
							$(self).css('transform', 'translate3d(0,' + (touch.pageY - downY)/3 + 'px, 0');

						} else if(iTop <= parentHeight - childHeight){
							// touch on the tail part of ul list
							if(switchTail) {
								switchTail = false;
								downY = touch.pageY;
							}

							$(self).css('transform', 'translate3d(0, ' + ( (touch.pageY - downY)/3 + (parentHeight - childHeight) ) + 'px, 0)');

						} else {
							// touch on the center part of ul list
							$(self).css('transform', 'translate3d(0,' + (touch.pageY - downY + downTop) + 'px, 0');
						}

						/*$(self).css('transform', 'translate3d(0,' + (touch.pageY - downY + downTop) + 'px, 0');*/
					});
					
					// here deal with the scroll back effect.
					$(document).on(touchend + '.move', function(ev) {
 						
 						// remove the '.move' gesture
						$(this).off('.move');
						// console.log(speed);

						if(!switchScroll) {

							// remove timer
							clearInterval(timer);

							timer = setInterval(function() {

								var iTop = $(self).position().top;

								if(Math.abs(speed) <= 0 || iTop > 50 || iTop < parentHeight - childHeight - 50) {
									clearInterval(timer);

									if(iTop >= 0) {
										$(self).css('transition', '.2s');
										$(self).css('transform', 'translate3d(0, 0, 0');
									} else if(iTop <= parentHeight - childHeight) {

										$(self).css('transition', '.2s');
										$(self).css('transform', 'translate3d(0, ' + (parentHeight - childHeight) +'px, 0');
									}

								} else {

									
									speed *= 0.9;
									$(self).css('transform', 'translate3d(0, ' + iTop + speed + 'px, 0');
								}

								

							}, 16);




						}

						
					});
					
					// prevent popup 
					return false;

				});

				$listContentUl.on('transitionend webkitTransitionEnd', function() {
					console.log(123);
					// clear transition
					$(this).css('transition', '');
				});
			}


			// show the music information on the bottom of music list page
			function show(sName, sMusicName, sImg) {
				$listAudioImg.attr('src', 'img/'+sImg);
				$listAudioText.find('h3').html(sMusicName);
				$listAudioText.find('p').html(sName);
				$listAudioBtn.show();
			}
			
			// provide interface by 'return'
			return {
				init: init,
				show: show
			};
		})();


		// music Details page 
		var musicDetails = (function() {

			// use RegExp to discompse the lyric
			var reg = /\[[^[]+/g;
			var arr = [];
			var $li = null;
			var iLiHeight = 0;

			var donwX = 0;
			var rangeX = 20;

			var timer = null;

			function init() {
				
				// in the initial stage, the details page is under the bottom.
				$musicDetails.css('transform', 'translate3d(0, ' + (viewHeight) + 'px, 0)');

				// let message part out of the details page (in the right slide of page)
				$detailsMessage.css('transform', 'translate3d(' + viewWidth + 'px, 0, 0)');

				bind();
			}
			
			// the details page slide up when click
			function slideUp() {
				$musicDetails.css('transition', '.5s');
				$musicDetails.css('transform', 'translate3d(0, 0, 0)');
			}
			
			// the details page slide down when click
			function slideDown() {
				$musicDetails.css('transform', 'translate3d(0, ' + (viewHeight) + 'px, 0)');
				
				// 
				$musicDetails.on('transitionend webkitTransitionEnd', function() {
					
					// let the lyric load again after click the next song
					$detailsLyric.add($detailsAudio).css('transform', 'translate3d(0, 0, 0)');
					$detailsMessage.css('transform', 'translate3d(' + (viewWidth) + 'px, 0, 0)');

					// change back the details button style
					$detailsBtn.find('li').eq(0).attr('class', 'active').siblings().attr('class', '');
				});
			}

			function bind() {

				$detailsTitle.on(touchstart, function() {
					slideDown();
				});

				// slide gesture
				$musicDetails.on(touchstart, function(ev) {
					
					var touch = ev.originalEvent.changedTouches ? ev.originalEvent.changedTouches[0] : ev;

					donwX = touch.pageX;

					$(document).on(touchend+'.move', function(ev) {
						
						$(this).off('.move');

						var touch = ev.originalEvent.changedTouches ? ev.originalEvent.changedTouches[0] : ev;
						// console.log(touch.pageX);

						if(touch.pageX - donwX < -rangeX) {  // slide to left

							// the lyric part and audio part outside the page
							$detailsLyric.add($detailsAudio).css('transform', 'translate3d(' + (-viewWidth) + 'px, 0, 0)');

							// the message part inside
							$detailsMessage.css('transform', 'translate3d(0, 0, 0)');

							// change details button style
							$detailsBtn.find('li').eq(1).attr('class', 'active').siblings().attr('class', '');
							
							// when slide left the details page, it will load the message.
							loadMessage();


							// deal with load message
							clearInterval(timer);
							timer = setInterval(scrollMessage, 3000);


						} else if(touch.pageX - donwX > rangeX  ) { // slide to right
							$detailsLyric.add($detailsAudio).css('transform', 'translate3d(0, 0, 0)');
							$detailsMessage.css('transform', 'translate3d(' + (viewWidth) + 'px, 0, 0)');

							// change back the details button style
							$detailsBtn.find('li').eq(0).attr('class', 'active').siblings().attr('class', '');

							clearInterval(timer);
						}

					});
				});
				
				// add message
				$detailsMessageBtn.on(touchstart, function() {
					addMessage();
				});
			}
			
			
			
			// show the music info in the music details page
			function show(sName, sMusicName, sLyric) {

				// show the title and name in detail page
				$detailsName.html(sMusicName + ' <span>' + sName + '</span>');

				// To avoid the lyric append to the previous song lyric, we must empty the previous lyric.
				$detailsLyricUl.empty().css('transform', 'translate3d(0, 0, 0)');

				// show the lyric from back end
				console.log(sLyric);
				arr = sLyric.match(reg);
				console.log(arr);

				// transfer to 2d array
				// [time] and lyric

				for(var i = 0; i < arr.length; i++) {
					arr[i] = [ formatLyricTime(arr[i].substring(0, 10) ), arr[i].substring(10).trim()];
				}
				

				console.log(arr); // 2d array
				// here arr[i][0] is [time]
				// arr[i][1] is 'lyric' !!!!!!
				for(var i = 0; i <arr.length; i++) {

					// append lyric to 'ul'
					$detailsLyricUl.append('<li>' + arr[i][1] + '</li>');

				}
				
				// find the first 'li' elem
				$li = $detailsLyricUl.find('li');
				$li.first().attr('class', 'active');
				// console.log($li.first());

				// get the true iLiHeight
				iLiHeight = $li.eq(7).outerHeight(true);
				console.log(iLiHeight);
			}
			
			// transfer [00:00.00] to 'seconds'
			function formatLyricTime(num) {
				// console.log(num); // [00:00.00]
				num = num.substring(1, num.length -1);
				// console.log(num); // 00:00.00

				var arr = num.split(':');
				// console.log(arr); // 00, 00.00

				// console.log(( parseFloat(arr[0]*60) + parseFloat(arr[1]) ).toFixed(2));
				return ( parseFloat(arr[0]*60) + parseFloat(arr[1]) ).toFixed(2);


			}

			function scrollLyric(ct) {
				// console.log(ct);
				for(var i = 0; i < arr.length; i++) {

					if(i != arr.length - 1 && ct > arr[i][0] && ct < arr[i+1][0]) {
						$li.eq(i).attr('class', 'active').siblings().attr('class', '');

						// change detailsLyricUl position
						if(i > 3) {
							// when the lyric line get 3 or more, the lyric will scroll up.
							$detailsLyricUl.css('transform', 'translate3d(0, ' + (-iLiHeight * (i - 3) ) + 'px, 0)');

						} else {
							// when we drag the play bar to the begin part.
							$detailsLyricUl.css('transform', 'translate3d(0, ' + (-iLiHeight * (i - 6) ) + 'px, 0)');
						}
						
					}

					else if (i == arr.length - 1 && ct > arr[i][0]) {
						
						// when the lyric get the last line
						$li.eq(i).attr('class', 'active').siblings().attr('class', '');
						$detailsLyricUl.css('transform', 'translate3d(0, ' + (-iLiHeight * (i - 6) ) + 'px, 0)');

					}
				}
			}
			
			// load message from back end
			function loadMessage() {
				$.ajax({
					url: 'loadMessage.php',
					type: 'GET',
					dataType: 'json',
					data: {
						mid: id
					},
					success: function(data) {
						// console.log(data);
						
						// empty the previous content.
						$detailsMessageUl.empty();

						$.each(data, function(key, obj) {
							var $li = $('<li>' + obj.text + '</li>');

							$detailsMessageUl.prepend($li);
						});
					}

				});
			}
			
			// add message
			function addMessage() {

				// get text value input
				var value = $detailsMessageText.val();
				$detailsMessageText.val('');
				$.ajax({
					
					url: 'addMessage.php',
					type: 'POST',
					dataType: 'json',
					data: {
						mid: id,
						text: value
					},
					success: function(data) {

						if(data.code) {
							var $li = $('<li>' + data.message + '</li>');
							$detailsMessageUl.prepend($li);
						}
					}
				});
			}
			
			// can scroll message automatically
			function scrollMessage() {
				
				var $lastMesg = $detailsMessageUl.find('li').last();
				$detailsMessageUl.prepend($lastMesg);
				$lastMesg.css('opacity', 0);

				setTimeout(function() {
					$lastMesg.css('opacity', 1);
				}, 300);
			}

			return {
				init: init,

				// 'slideUp' method should be invoked in the 'musicList' function.
				slideUp: slideUp,
				slideDown: slideDown,
				show: show,
				scrollLyric: scrollLyric
			};

		})();
		
		// music play method
		var musicAudio = (function() {

			var switchBtn = true;
			// set timer to call 'playing' method
			var timer = null;
			// set proup line
			var scale = 0;

			var disX = 0;

			var parentWidth = $detailsAudioProBar.parent().width();
			
			function init() {
				bind();
			}

			function loadMusic(id) {
				// load music
				$.ajax({
					url: 'musicAudio.php',
					type: 'GET',
					dataType: 'json',
					data: {
						id: id
					},
					// let iphone can play automatically
					async: false,
					success: function(data) {
						// console.log(data);
						show(data);
					}
				});

			}
			
			/*
				here 'show' only control the audio 

			*/ 
			function show(obj) {
				var sName = obj.name;
				var sMusicName = obj.musicName;
				var sLyric = obj.lyric;
				var sImg = obj.img;
				var sAudio = obj.audio;

				// console.log(sName, sMusicName, sLyric, sImg, sAudio);

				musicList.show(sName, sMusicName, sImg);
				musicDetails.show(sName, sMusicName, sLyric);
				oAudio.src = 'img/' + sAudio;
				// console.log(oAudio);
				// after load music
				
				// 'one' avoid bind more than one time

				play(); // sync for iphone

				$(oAudio).one('canplaythrough', function() {
					// play();

					// console.log(formatTime(oAudio.duration));

					$detailsAllTime.html(formatTime(oAudio.duration));
				});
				
				// when play completed, invoke 'ended' event
				$(oAudio).one('ended', function() {
					next(); 
				});


			}

			function play() {
				
				switchBtn = false;

				// let image rotate
				$listAudioImg.addClass('move');
				// set button as 'pause'
				$listAudioBtn.css('backgroundImage', 'url(img/list_audioPause.png)');

				// set button on details page
				$detailsPlay.css('backgroundImage', 'url(img/details_pause.png)');

				// play audio
				oAudio.play();

				playing();

				clearInterval(timer);

				timer = setInterval(playing, 1000);

				

			}

			function pause() {

				switchBtn = true;
				// let image rotate
				$listAudioImg.removeClass('move');
				// set button as 'pause'
				$listAudioBtn.css('backgroundImage', 'url(img/list_audioPlay.png)');

				// set play button on details page
				$detailsPlay.css('backgroundImage', 'url(img/details_play.png)');

				// play audio
				oAudio.pause();
				
				// when pause, clear timer
				clearInterval(timer);
			}
			
			// 'bind' method used to deal with gesture event
			function bind() {
				// set two elems at the same time.
				$listAudioBtn.add($detailsPlay).on(touchstart, function() {
					if(switchBtn) {
						play();
					} else {
						pause();
					}
					// avoid click btn to slideup
					return false;
				});
				
				// 'drag' method compose !!!
				$detailsAudioProBar.on(touchstart, function(ev) {

					var touch = ev.originalEvent.changedTouches ? ev.originalEvent.changedTouches[0] : ev;

					var self = this;

					disX = touch.pageX - $(this).position().left;

					// console.log(disX);
					
					// if we drag the bar, we stop the bar automatic movement.
					clearInterval(timer);

					$(document).on(touchmove+'.move', function(ev) {

						var touch = ev.originalEvent.changedTouches ? ev.originalEvent.changedTouches[0] : ev;
						$(self).css('left', touch.pageX - disX);

						// set the range of bar movement
						var L = touch.pageX - disX;
						if (L < 0) {
							L = 0;
						} else if (L > parentWidth) {
							L = parentWidth
						} 

						$(self).css('left', L);
						scale = L / parentWidth;
					});

					$(document).on(touchend+'.move', function(ev) {
						$(this).off('.move');

						// change scale to change currentTime playtime.
						oAudio.currentTime = scale * oAudio.duration;

						// when startend, continue the bar auto movement
						playing();
						clearInterval(timer);
						timer = setInterval(playing, 1000);
					});

					return false;
				});

				$detailsPrev.on(touchstart, function() {
					prev();
				});

				$detailsNext.on(touchstart, function() {
					next();
				})

			}
			
			// format oAudio.duration (seconds) to (min:sec);
			function formatTime(num) {
				num = parseInt(num);
				var iM = Math.floor(num%3600/60);
				var iS = Math.floor(num%60);

				return toZero(iM) + ':' + toZero(iS);
			}

			function toZero(num) { // add zero when less than 10
				return num = num < 10 ? '0'+num : num;
			}
			
			// when playing, set the playing time and playbar change.
			function playing() {

				// set the current time as 'detailsNowTime' content
				$detailsNowTime.html(formatTime(oAudio.currentTime));
				// set scale
				scale = oAudio.currentTime / oAudio.duration;
				
				// the scale change the position of proup and bar.
				$detailsAudioProUp.css('width', scale * 100 + '%');
				$detailsAudioProBar.css('left', scale * 100 + '%');
				
				// transfer into the current time
				musicDetails.scrollLyric(oAudio.currentTime);
			}

			function next() {
				// play next song
				var $li = $listContentUl.find('li');
				// console.log($li);
				index = index == $li.length - 1 ? 0 : index + 1;
				console.log(index);
				id = $li.eq(index).attr('musicId');
				$li.eq(index).attr('class', 'active').siblings().attr('class', '');
				loadMusic(id)
			}

			function prev() {
				// play previous song
				// play next song
				var $li = $listContentUl.find('li');

				index = index == 0 ? $li.length - 1 : index - 1;
				id = $li.eq(index).attr('musicId');
				loadMusic(id)

			}

			return {
				init: init,
				loadMusic: loadMusic
			};

		})();

		init();











	</script>
</body>
</html>