<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0, user-scalable=no">

	<title>Music Player</title>
	<style type="text/css">
		* {
			margin: 0;
			padding: 0;
		}

		html {
			width: 100%;
			height: 100%;
			overflow: hidden;
		}

		body {
			width: 100%;
			height: 100%;
			font: 14px/1.5 Tahoma, Arial, Roboto, "Droid Sans", sans-self;
		}

		li {
			list-style: none;
		}

		#main {
			width: 100%;
			height: 100%;
			position: relative;
			margin: 0 auto;
		}

		#musicList {
			width: 100%;
			height: 100%;
			background: url(img/bg.jpg) no-repeat;
			background-size: cover;
		}

		#musicList .list_title {
			width: 100%;
			height: 40px;
			background: rgba(41, 171, 226, 0.6);
			font-size: 20px;
			line-height: 40px;
			text-align: center;
			color: white;
			position: absolute;
			top: 0;
		}

		#musicList .list_tip {
			width: 16px;
			height: 16px;
			background: url(img/tip.png) no-repeat;
			background-size: cover;
			position: absolute;
			right: 15px;
			top: 12px;
		}

		#musicList .list_content {
			width: 100%;
			position: absolute;
			top: 39px;
			bottom: 65px;
			overflow: hidden;
		}

		#musicList .list_content ul {
			width: 100%;
			position: absolute;
			top: 0;
			left: 0;
			transform: translate3d(0, 0, 0);
		}

		#musicList .list_content ul li {
			width: 100%;
			height: 60px;
			background: rgb(26, 26, 26, 0.6);
			border-bottom: 1px solid #999;
			box-sizing: border-box;
		}

		#musicList .list_content ul li.active {
			border-left: 6px solid #29abe2;
		}

		#musicList .list_audio {
			width: 100%;
			height: 65px;
			background: url(img/list_audioBg.png) repeat-x;
			position: absolute;
			bottom: 0;
		}

		#musicList .list_audioImg {
			width: 50px;
			border-radius: 50%;
			float: left;
			margin: 7px 0 0 15px;
		}
		
		#musicList .list_audioText {
			float: left;
		}

		#musicList .list_audioBtn {
			float: right;
			width: 32px;
			height: 32px;
			background: url(img/list_audioPlay.png) no-repeat;
			display: none;
			background-size: cover;
			margin: 16px 15px 0 0;
		}

		.title {
			 color: white;
			 font-size: 15px;
			 padding: 10px 0 0 20px;
		}

		.name {
			color: lightgrey;
			font-size: 12px;
			padding: 2px 0 0 20px;
		}



	</style>
</head>
<body>
	
	<div id="main">
		<div id="musicList">
			<div id="listTitle" class="list_title">Ajax Music Player<span class="list_tip"></span></div>

			<div id="listContent" class="list_content">
				<ul id="listContentUl">
					<!-- <li class="active">
						<h3 class="title">song name</h3>
						<p class="name">singer</p>
					</li> -->


					

				</ul>
			</div>

			<div class="list_audio">
				<img class="list_audioImg" src="img/miaov.jpg">
				<div class="list_audioText">
					<h3 class="title">Simulation</h3>
					<p class="name">Music Player</p>
				</div>
				<div class="list_audioBtn"></div>
			</div>
		</div>
	</div>

	<script type="text/javascript" src="jquery-2.1.3.min.js"></script>
	<script type="text/javascript">
		
		// console.log($(window).width()); // set width

		var viewWidth = $(window).width();
		var viewHeight = $(window).height();
		var desWidth = 640;

		// set three variable used to flag the touch method
		var touchstart = 'touchstart';
		var touchmove = 'touchmove';
		var touchend = 'touchend';

		var $main = $('#main');
		var $listContent = $('#listContent');

		var $listContentUl = $('#listContentUl');
		var $listTitle = $('#listTitle');

		function init() {
			// the whole project init method
			device();
			musicList.init();

		}

		
		function device() {
			// compatible desk and mobile end layout

			// console.log(navigator.userAgent);
			// through RegExp to confirm is mobile end or pc end.
			var isMobile = /Mobile/i.test(navigator.userAgent);
			console.log(isMobile);
			
			// confirm whether the device is mobile or pc
			if(viewWidth > desWidth) {
				
				// if it is pc, will let the pc device width is 640px
				$main.css('width', '640px');
			}
			
			// mobile 'touch' gesture is different from pc 'touch' gesture, if it is pc device, 'touch' means mouse click.
			if(!isMobile) {
				touchstart = 'mousedown';
				touchmove = 'mousemove';
				touchend = 'mouseup';
			}
		}
		
		// music list operation by IIFE 
		var musicList = (function() {
			
			// set url variable
			var musicUrl = 'http://play.google.com';
			var listUrl = 'musicList.php';
			
			// deal with scroll gesture
			var downY = 0;
			// the last previous y
			var preY = 0;
			var downTop = 0;

			// deal with content height, if list is less than content, donot need scroll.
			var parentHeight = $listContent.height();
			var childHeight = $listContentUl.height();

			// the switches deal with scroll gesture
			// head scroll
			var switchHead = true;
			// tail scroll
			var switchTail = true;
			// click scroll
			var switchScroll = true;

			// deal with scroll back when touchend.
			var timer = null;
			var speed = 0;
			
			// set 'init' function
			function init() {  // initiate the musiclist
				data();
				bind();
				moveScroll();
			}
			
			// get data from backend php file
			function data() { // get data
				
				/*
					here will get the data from backend database by jquery ajax
				*/

				$.ajax({
					url: listUrl, // the backend php file
					type: 'GET',
					dataType: 'json',
					success: function(data) {
						$.each(data, function(k, obj) {
							// traverse the 'data' and get 'obj' content
							var $li = '<li><h3 class="title">' + obj.musicName + '</h3><p class="name">' + obj.name + '</p></li>';
							// append to 'ul' elem
							$listContentUl.append($li);
						});
						
						// prevent asynchronous ajax affect child has no height.
						childHeight = $listContentUl.height();
					}
				});
			}

			function bind() {
				// click the 'list_title' to jump to another webpage
				$listTitle.on(touchstart, function() {
					// alert(666);

					window.location = musicUrl;
				});
				
				// by 'delegate' to bind with 'li'
				if(switchScroll) {
					
					// click 'li' to select li
					$listContentUl.delegate('li', touchend, function() {

						// by jquery to remove all siblings 'class' attribute.
						$(this).attr('class', 'active').siblings().attr('class', '');
					});

				}
			}
			
			// scroll the music list 
			function moveScroll() {
				
				// remove the default scroll gesture
				$(document).on(touchmove, function(ev) {
					ev.preventDefault();
				});
				
				/*
					touchstart {touchmove, touchend} three events

				*/ 
				$listContentUl.on(touchstart, function(ev) {
					
					// if ul list less than content height, no scroll gesture
					if(parentHeight > childHeight) {
						return false;
					}

					// ev.pageX,  touch.pageX

					// ev.originalEvent -> JQ event to js event
					// compatible with the pc and mobile 'touch'
					var touch = ev.originalEvent.changedTouches ? ev.originalEvent.changedTouches[0] : ev;
					
					// store the pageY
					downY = touch.pageY;
					preY = touch.pageY;
					downTop = $(this).position().top;

					var self = this;

					switchHead = true;
					switchTail = true;
					switchScroll = true;
					
					// remove timer
					clearInterval(timer);

					// console.log(touch.pageX);
				
					$(document).on(touchmove + '.move', function(ev) {
						
						// alert(666);
						switchScroll = false;

						var touch = ev.originalEvent.changedTouches ? ev.originalEvent.changedTouches[0] : ev;

						var iTop = $(self).position().top;
						
						// get speed value
						speed = touch.pageY - preY;
						preY = touch.pageY;

						if(iTop >= 0) {
							
							if(switchHead) {
								switchHead = false;
								downY = touch.pageY;
							}

							// touch on the head part of ul list
							$(self).css('transform', 'translate3d(0,' + (touch.pageY - downY)/3 + 'px, 0');

						} else if(iTop <= parentHeight - childHeight){
							// touch on the tail part of ul list
							if(switchTail) {
								switchTail = false;
								downY = touch.pageY;
							}

							$(self).css('transform', 'translate3d(0, ' + ( (touch.pageY - downY)/3 + (parentHeight - childHeight) ) + 'px, 0)');

						} else {
							// touch on the center part of ul list
							$(self).css('transform', 'translate3d(0,' + (touch.pageY - downY + downTop) + 'px, 0');
						}

						/*$(self).css('transform', 'translate3d(0,' + (touch.pageY - downY + downTop) + 'px, 0');*/
					});
					
					// here deal with the scroll back effect.
					$(document).on(touchend + '.move', function(ev) {
 						
 						// remove the '.move' gesture
						$(this).off('.move');
						// console.log(speed);

						if(!switchScroll) {

							// remove timer
							clearInterval(timer);

							timer = setInterval(function() {

								var iTop = $(self).position().top;

								if(Math.abs(speed) <= 0 || iTop > 50 || iTop < parentHeight - childHeight - 50) {
									clearInterval(timer);

									if(iTop >= 0) {
										$(self).css('transition', '.2s');
										$(self).css('transform', 'translate3d(0, 0, 0');
									} else if(iTop <= parentHeight - childHeight) {

										$(self).css('transition', '.2s');
										$(self).css('transform', 'translate3d(0, ' + (parentHeight - childHeight) +'px, 0');
									}

								} else {

									
									speed *= 0.9;
									$(self).css('transform', 'translate3d(0, ' + iTop + speed + 'px, 0');
								}

								

							}, 16);




						}

						
					});
					
					// prevent popup 
					return false;

					$listContentUl.on('transitionend webkitTransitionEnd', function() {
						// console.log(123);
						// clear transition
						$(this).css('transition', '');
					});
				});
			}
			
			// provide interface by 'return'
			return {
				init: init
			};
		})();

		

		init();











	</script>
</body>
</html>